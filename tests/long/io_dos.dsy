module io_dos_test

import stdlib_io
import stdlib_strings
import stdlib_strings_ext

fn main() -> int:
  set path = "build/io_dos.txt"
  set payload = stdlib_strings_ext.repeat("abcd", 16384)
  set i = 0
  while i < 5:
    set _ = stdlib_io.write_all(path, payload)
    set content = stdlib_io.read_all(path)
    if stdlib_strings.is_null(content):
      return 1
    if stdlib_strings.len(content) != stdlib_strings.len(payload):
      return 1
    set _ = stdlib_strings.str_release(content)
    set i = i + 1
  set _ = stdlib_strings.str_release(payload)
  print "OK"
  return 0

